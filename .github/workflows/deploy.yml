name: Deploy Blog

on:
  # Scheduled daily build at 9 AM UTC (adjust timezone as needed)
  schedule:
    - cron: '0 9 * * *'
  
  # Manual trigger via GitHub UI
  workflow_dispatch:
    inputs:
      deploy_reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'
        type: string

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Prevent concurrent deployments
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper git info
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          cache: 'pip'
      
      - name: Cache MkDocs dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          pip install mkdocs mkdocs-material
          # Add any other MkDocs plugins you need
          
      - name: Validate content
        run: |
          echo "Validating markdown files..."
          find docs -name "*.md" -type f | while read file; do
            if [[ ! -s "$file" ]]; then
              echo "Warning: Empty file detected: $file"
            fi
          done
          
          echo "Checking for published posts..."
          published_count=$(find docs/blog/posts -name "*.md" -type f -exec grep -l "^drafting:[[:space:]]*[Ff][Aa][Ll][Ss][Ee]" {} \; 2>/dev/null | wc -l || echo "0")
          echo "Found $published_count published posts"
          
          if [[ $published_count -eq 0 ]]; then
            echo "No published posts found, creating placeholder..."
            mkdir -p docs/blog/posts
            cat > docs/blog/posts/welcome.md << 'EOF'
          ---
          drafting: false
          date: $(date +%Y-%m-%d)
          ---
          
          # Welcome
          
          Welcome to my blog! Posts will appear here once published.
          EOF
          fi
      
      - name: Build with MkDocs
        run: |
          echo "Building site with MkDocs..."
          mkdocs build --verbose --strict
          
          # Verify build output
          if [[ ! -d "site" ]]; then
            echo "ERROR: Build failed - site directory not created"
            exit 1
          fi
          
          echo "Build completed successfully"
          echo "Generated files:"
          find site -type f | head -20
      
      - name: Setup Pages
        uses: actions/configure-pages@v3
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./site
  
  # Deploy job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
      
      - name: Deployment summary
        run: |
          echo "🚀 Deployment completed successfully!"
          echo "📄 Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "⏰ Deployed at: $(date)"
          echo "🔄 Trigger: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "📝 Reason: ${{ github.event.inputs.deploy_reason }}"
          fi